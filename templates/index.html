<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta charset="UTF-8">
    <title>Terraform_toy!</title>
    <link rel="stylesheet" href="/static/style.css">
    <script type="text/javascript" src="/static/radicals.js"></script>

    <style type="text/css">
        body {
            user-select: none;
        }

        h4 {
            font-family: sans-serif;
        }

        p {
            font-family: sans-serif;
        }

        a {
            font-family: sans-serif;
            color: #d15423;
            text-decoration: none;
        }
    </style>


</head>

<body>
    {% include "header.html" %}
    <hr />
    <table border='1'>
        <tr>

            <td valign="top" align="right">
                <button onClick="getTwoRandomKanjis()">get 2 diff kanjis</button>
            </td>
            <td valign="top">
                <canvas id="canvas" width="400" height="400"></canvas>
            </td>
            <td valign="top">
                <table border="1">
                    <tr>
                        <th>active</th>
                        <th>state</th>
                        <!-- <th>lastActive</th> -->
                    </tr>
                    <tr>
                        <th id="active">&nbsp;</th>
                        <th id="state">&nbsp;</th>
                        <!-- <th id="lastActive">&nbsp;</th> -->
                        
                    </tr>

                </table>
                <table border="1">
                    <tr>
                        <th>name</th>
                        <th>x</th>
                        <th>y</th>
                        <th>kanji</th>
                        <th>size</th>
                        <th>english</th>
                        <th>bigger</th>
                        <th>smaller</th>
                    </tr>
                    <tr>
                        <td id="nA"></td>
                        <td id="xA"></td>
                        <td id="yA"></td>
                        <td id="kA"></td>
                        <td id="sA"></td>
                        <td id="eA"></td>
                        <td><button onClick='sizer(0, 2)'>A+</button></td>
                        <td><button onClick='sizer(0, -2)'>A-</button></td>
                    </tr>
                    <tr>
                        <td id="nB"></td>
                        <td id="xB"></td>
                        <td id="yB"></td>
                        <td id="kB"></td>
                        <td id="sB"></td>
                        <td id="eB"></td>
                        <td><button onClick='sizer(1, 2)'>B+</button></td>
                        <td><button onClick='sizer(1, -2)'>B-</button></td>

                    </tr>

                </table>


            </td>




        </tr>
    </table>
    <hr />


    <script>
        class Thing {
            constructor(x, y, kanji, name, english) {
                this.size = 100
                this.x = x
                this.y = y
                this.kanji = kanji
                this.name = name
                this.english = english

            }
            updateDom() {
                const n = 'n' + this.name
                const x = 'x' + this.name
                const y = 'y' + this.name
                const k = 'k' + this.name
                const s = 's' + this.name
                const e = 'e' + this.name

                document.getElementById(n).innerHTML = "&nbsp;&nbsp; " + this.name
                document.getElementById(x).innerHTML = this.x
                document.getElementById(y).innerHTML = this.y
                document.getElementById(k).innerHTML = "&nbsp;&nbsp; " + this.kanji
                document.getElementById(s).innerHTML = this.size
                document.getElementById(e).innerHTML = this.english
            }
        }


    </script>



    <script>
        function setState() {
            if ( isMouseDown ) {
                state = LOCKED
            } else {
                state = UNLOCKED
            } 
            document.getElementById("state").innerHTML = state
        }
        // Globals
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let screenRect;
        let twoKanjis = []
        let prevMouseX, prevMouseY;
        let isMouseDown = false;
        const NILL = -1
        let active = 0
        let lastActive = undefined
        const UNLOCKED = "UNLOCKED"
        const LOCKED = "LOCKED"
        let state = UNLOCKED
        //
        function sizer(index, newSize) { 
            twoKanjis[index].size += newSize
        }

        function getTwoRandomKanjis() { 
            const left = getRandomThingByType(positions.LEFT)
            const nill = getRandomThingByType(positions.LEFT)
            twoKanjis = [] 
            twoKanjis.push(new Thing(200, 100, left.k, "A", left.e))
            twoKanjis.push(new Thing(250, 200, nill.k, "B", nill.e))
            console.log("left " + JSON.stringify( left ))
            console.log("nill " + JSON.stringify( nill ))
            twoKanjis[0].updateDom()
            twoKanjis[1].updateDom()

        }

        function init() {
            screenRect = canvas.getBoundingClientRect();
            const goat = getSomeRandomThing() 

            getTwoRandomKanjis()
            addKeyEventListener();

            animate();
        }
        function isInBounds(x, y) {
            if ( x > 0 && y > 0 && x < canvas.width && y <canvas.height ) {
                return true
            }
            return false 
        }
        function addKeyEventListener() {
            canvas.onmousedown = function (e) {
                prevMouseX = event.clientX - screenRect.left;
                prevMouseY = event.clientY - screenRect.top;
                isMouseDown = true;
                setState(isMouseDown)
            }
            canvas.onmousemove = function (e) {
                if (isMouseDown && active !== NILL) {
                    const x = event.clientX - screenRect.left;
                    const y = event.clientY - screenRect.top;

                    let horizon = 100
                    let actual = 10000000;
                    let found = NILL
                    twoKanjis.forEach((thing, i) => {
                        const d = Math.sqrt((thing.x - x) * (thing.x - x) + (thing.y - y) * (thing.y - y));
                        // console.log( i + "    " + x + "   y " + y + "   " + d )
                        if (d < actual && d < horizon) {
                            actual = d
                            found = i
                        }
                    })
                    if (found !== NILL) {
                        if (lastActive !== active) {
                            lastActive = active
                            twoKanjis[active].updateDom()
                            // console.log("%c " + active + " " + lastActive, "background:blue")
                        }
                        active = found
                        document.getElementById("active").innerHTML = twoKanjis[active].name
                        const dx = x - prevMouseX;
                        const dy = y - prevMouseY;

                        const candidateX = twoKanjis[active].x + dx
                        const candidateY = twoKanjis[active].y + dy
                        if (isInBounds(candidateX, candidateY)) {
                            twoKanjis[active].x = candidateX
                            twoKanjis[active].y = candidateY
                            prevMouseX = x;
                            prevMouseY = y;
                        }
                    }
                }

            }

            canvas.onmouseup = function (e) {
                //var x = event.clientX - screenRect.left;
                //var y = event.clientY - screenRect.top;
                isMouseDown = false;
                isRectSelected = false;
                // active = NILL
                setState(isMouseDown)

            }

            canvas.onmouseout = function (e) {
                isMouseDown = false;
            }
        }

        function animate() {
            drawCanvasBackground();
            draw();
            requestAnimationFrame(function () {
                // The window.requestAnimationFrame() method tells the browser 
                // that you wish to perform an animation and requests that the 
                // browser calls a specified function to update an animation before 
                // the next repaint. The method takes a callback as an argument to 
                // be invoked before the repaint.
                animate();
            });
        }

        function drawCanvasBackground() {
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.stroke();
        }

        function draw() {
            ctx.strokeStyle = 'black';
            twoKanjis.forEach((thing) => {
                // ctx.beginPath();
                // ctx.arc(thing.x, thing.y, thing.size, 0, 2 * Math.PI);
                // ctx.stroke();
                ctx.fillStyle = "black";
                ctx.strokeStyle = "black";
                ctx.textAlign = "end";
                ctx.font = `${thing.size}px Arial`;
                ctx.fillText(thing.kanji, thing.x, thing.y);
                ctx.stroke();
            })
        }



        init()
    </script>

</body>

</html>
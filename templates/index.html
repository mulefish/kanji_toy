<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <meta charset="UTF-8">
    <title>Terraform_toy!</title>
    <link rel="stylesheet" href="/static/style.css">
    <script type="text/javascript" src="/static/radicals.js"></script>

    <style type="text/css">
        body{
user-select: none;
}
        h4 {
            font-family: sans-serif;
        }

        p {
            font-family: sans-serif;
        }

        a {
            font-family: sans-serif;
            color: #d15423;
            text-decoration: none;
        }
    </style>


</head>

<body>
    {% include "header.html" %}
    <hr />
    <table border='1'>
        <tr>

            <td valign="top" align="right">
                <!-- <button onClick='getType("NILL")'>NILL</button><br /> -->
                <button onClick='getType("TOP")'>TOP</button><br />
                <button onClick='getType("LEFT")'>LEFT</button><br />
                <button onClick='getType("BOTTOM")'>BOTTOM</button><br />
                <button onClick='getType("LEFT_TOP_RIGHT")'>LEFT_TOP_RIGHT</button><br />
                <button onClick='getType("RIGHT")'>RIGHT</button><br />
                <button onClick='getType("LEFT_BOTTOM_RIGHT")'>LEFT_BOTTOM_RIGHT</button><br />
                <button onClick='getType("TOP_RIGHT")'>TOP_RIGHT</button><br />
                <button onClick='getType("LEFT_TOP_BOTTOM")'>LEFT_TOP_BOTTOM</button><br />
                <button onClick='getType("LEFT_TOP")'>LEFT_TOP</button><br />
                <button onClick='getType("ALL")'>ALL</button><br />
                <button onClick='getType("LEFT_BOTTOM")'>LEFT_BOTTOM</button><br />
                <button onClick='getType("TOP_LEFT")'>TOP_LEFT</button><br />
                <button onClick='getType("UPPERLEFT_CENTER_BOTTOMRIGHT")'>UPPERLEFT_CENTER_BOTTOMRIGHT</button><br />
                <button onClick='getType("LEFT_RIGHT")'>LEFT_RIGHT</button>
            </td>
            <td valign="top">
                <canvas id="canvas" width="400" height="400"></canvas>
            </td>
            <td valign="top">
                <table border="1">
                    <tr>
                        <th>active</th>
                        <th>state</th>
                    </tr>
                    <tr>
                        <th id="active">&nbsp;</th>
                        <th id="state">&nbsp;</th>
                    </tr>

                </table>
                <table border="1">
                    <tr>
                        <th>name</th>
                        <th>x</th>
                        <th>y</th>
                        <th>kanji</th>
                        <th>size</th>
                    </tr>
                    <tr>
                        <td id="nA"></td>
                        <td id="xA"></td>
                        <td id="yA"></td>
                        <td id="kA"></td>
                        <td id="sA"></td>
                    </tr>
                    <tr>
                        <td id="nB"></td>
                        <td id="xB"></td>
                        <td id="yB"></td>
                        <td id="kB"></td>
                        <td id="sB"></td>
                    </tr>

                </table>


            </td>




        </tr>
    </table>
    <hr />


    <script>
        class Thing {
            constructor(x, y, kanji, name) {
                this.x = x
                this.y = y
                this.kanji = kanji
                this.name = name
                this.size = 100

            }
            updateDom() {
                const n = 'n' + this.name
                const x = 'x' + this.name
                const y = 'y' + this.name
                const k = 'k' + this.name
                const s = 's' + this.name

                document.getElementById(n).innerHTML = "&nbsp;&nbsp; " + this.name
                document.getElementById(x).innerHTML = this.x
                document.getElementById(y).innerHTML = this.y
                document.getElementById(k).innerHTML = "&nbsp;&nbsp; " + this.kanji
                document.getElementById(s).innerHTML = this.size


            }
        }


    </script>



    <script>




        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let screenRect;
        const twoKanjis = []
        let prevMouseX, prevMouseY;
        let isMouseDown = false;
        const NILL = -1
        let active = 0
        let lastActive = undefined

        function init() {
            screenRect = canvas.getBoundingClientRect();

            twoKanjis.push(new Thing(100, 100, "⼌", "A"))
            twoKanjis.push(new Thing(50, 50, "⼛", "B"))
            twoKanjis[0].updateDom()
            twoKanjis[1].updateDom()
            addKeyEventListener();

            animate();
        }

        function addKeyEventListener() {

            canvas.onmousedown = function (e) {
                prevMouseX = event.clientX - screenRect.left;
                prevMouseY = event.clientY - screenRect.top;
                isMouseDown = true;
                //                document.getElementById("active").innerHTML = twoKanjis[active].name
            }

            canvas.onmousemove = function (e) {
                if (isMouseDown && active !== NILL) {
                    const x = event.clientX - screenRect.left;
                    const y = event.clientY - screenRect.top;

                    let horizon = 100
                    let actual = 10000000;
                    let found = NILL
                    twoKanjis.forEach((thing, i) => {
                        const d = Math.sqrt((thing.x - x) * (thing.x - x) + (thing.y - y) * (thing.y - y));
                        // console.log( i + "    " + x + "   y " + y + "   " + d )
                        if (d < actual && d < horizon) {
                            actual = d
                            found = i
                        }
                    })
                    if (found !== NILL) {
                        if (lastActive !== active) {
                            lastActive = active
                            twoKanjis[active].updateDom()
                            console.log("%c " + active + " " + lastActive, "background:blue")
                        }
                        active = found
                        document.getElementById("active").innerHTML = twoKanjis[active].name
                        const dx = x - prevMouseX;
                        const dy = y - prevMouseY;
                        if (twoKanjis[active].x + dx > 0) {
                            if (twoKanjis[active].y + dy > 0) {
                                twoKanjis[active].x += dx
                                twoKanjis[active].y += dy
                                prevMouseX = x;
                                prevMouseY = y;
                            }
                        }
                    }
                }
            }

            canvas.onmouseup = function (e) {
                //var x = event.clientX - screenRect.left;
                //var y = event.clientY - screenRect.top;
                isMouseDown = false;
                isRectSelected = false;

            }

            canvas.onmouseout = function (e) {
                isMouseDown = false;
            }
        }

        function animate() {
            drawCanvasBackground();
            draw();
            requestAnimationFrame(function () {
                // The window.requestAnimationFrame() method tells the browser 
                // that you wish to perform an animation and requests that the 
                // browser calls a specified function to update an animation before 
                // the next repaint. The method takes a callback as an argument to 
                // be invoked before the repaint.
                animate();
            });
        }

        function drawCanvasBackground() {
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';

            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.stroke();
        }

        function draw() {
            ctx.strokeStyle = 'black';
            twoKanjis.forEach((thing) => {
                // ctx.beginPath();
                // ctx.arc(thing.x, thing.y, 20, 0, 2 * Math.PI);
                // ctx.stroke();
                ctx.fillStyle = "black";
                ctx.strokeStyle = "black";
                ctx.font = "35px Arial";
                ctx.fillText(thing.kanji, thing.x, thing.y);
                ctx.stroke();
            })
        }



        init()
    </script>

</body>

</html>